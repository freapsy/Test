<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manager Dashboard - NorthDrive</title>
  <link rel="stylesheet" href="transport-style.css">
  <style>
    .dashboard-container {
      display: flex;
      min-height: 70vh;
    }
    
    .sidebar {
      width: 250px;
      background-color: var(--bg-light);
      padding: 2rem 1rem;
      border-right: 1px solid var(--border-color);
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-menu li {
      margin-bottom: 0.5rem;
    }
    
    .sidebar-menu a {
      display: block;
      padding: 0.8rem 1rem;
      color: var(--text-color-primary);
      text-decoration: none;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background-color: var(--accent-blue);
      color: white;
    }
    
    .sidebar-menu a i {
      margin-right: 0.5rem;
      width: 20px;
      text-align: center;
    }
    
    .content-area {
      flex: 1;
      padding: 2rem;
    }
    
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .user-welcome {
      font-size: 1.2rem;
    }
    
    .user-welcome strong {
      color: var(--accent-blue);
    }
    
    .loading-name {
      display: inline-flex;
      align-items: center;
      position: relative;
    }
    
    .loading-name::after {
      content: "";
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-left: 8px;
      border: 2px solid var(--accent-blue);
      border-radius: 50%;
      border-top-color: transparent;
      animation: loading-spinner 1s linear infinite;
    }
    
    @keyframes loading-spinner {
      to {
        transform: rotate(360deg);
      }
    }
    
    .logout-btn {
      background-color: transparent;
      color: var(--accent-blue);
      border: 1px solid var(--accent-blue);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background-color: var(--accent-blue);
      color: white;
    }
    
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background-color: var(--bg-light);
      border-radius: 4px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .stat-card h3 {
      margin-top: 0;
      color: var(--text-color-secondary);
      font-size: 1rem;
      font-weight: 500;
    }
    
    .stat-card .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-navy);
      margin: 0.5rem 0;
    }
    
    .stat-card .stat-change {
      font-size: 0.9rem;
      color: #5cb85c;
    }
    
    .stat-card .stat-change.negative {
      color: #d9534f;
    }
    
    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .section-title h2 {
      margin: 0;
      padding: 0;
      border: none;
    }
    
    .section-title .view-all {
      color: var(--accent-blue);
      text-decoration: none;
      font-size: 0.9rem;
    }
    
    .section-title .view-all:hover {
      text-decoration: underline;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .dashboard-card {
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .dashboard-card-header {
      background-color: var(--bg-light);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .dashboard-card-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--primary-navy);
    }
    
    .dashboard-card-body {
      padding: 1.5rem;
    }
    
    .orders-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .orders-table th, 
    .orders-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    .orders-table th {
      background-color: var(--bg-light);
      color: var(--text-color-secondary);
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .orders-table tr:hover {
      background-color: rgba(0, 102, 179, 0.05);
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-badge.pending {
      background-color: rgba(255, 193, 7, 0.2);
      color: #856404;
    }
    
    .status-badge.in-progress {
      background-color: rgba(0, 123, 255, 0.2);
      color: #004085;
    }
    
    .status-badge.completed {
      background-color: rgba(40, 167, 69, 0.2);
      color: #155724;
    }
    
    .status-badge.cancelled {
      background-color: rgba(220, 53, 69, 0.2);
      color: #721c24;
    }
    
    .driver-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .driver-item {
      display: flex;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .driver-item:last-child {
      border-bottom: none;
    }
    
    .driver-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--accent-blue);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      margin-right: 1rem;
    }
    
    .driver-info {
      flex: 1;
    }
    
    .driver-name {
      font-weight: 500;
      margin-bottom: 0.2rem;
    }
    
    .driver-status {
      font-size: 0.8rem;
      color: var(--text-color-secondary);
    }
    
    .driver-status.available {
      color: #28a745;
    }
    
    .driver-status.busy {
      color: #dc3545;
    }
    
    .chart-container {
      height: 300px;
      position: relative;
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .action-btn {
      background-color: var(--accent-blue);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .action-btn:hover {
      background-color: var(--accent-color-darker);
    }
    
    .notification-item {
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .notification-item:last-child {
      border-bottom: none;
    }
    
    .notification-title {
      font-weight: 500;
      margin-bottom: 0.3rem;
    }
    
    .notification-time {
      font-size: 0.8rem;
      color: var(--text-color-secondary);
    }

    /* Whitelist-Verwaltung Styles */
    .whitelist-section {
      padding: 1.5rem;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .whitelist-form {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
      margin-bottom: 1.5rem;
    }

    .whitelist-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .whitelist-table th,
    .whitelist-table td {
      padding: 0.8rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .whitelist-table th {
      background-color: var(--bg-light);
      font-weight: 500;
    }

    .whitelist-table tr:hover {
      background-color: var(--bg-light);
    }

    .whitelist-actions {
      display: flex;
      gap: 0.5rem;
    }

    .whitelist-status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      font-size: 0.9rem;
    }

    .whitelist-status.active {
      background-color: #dff0d8;
      color: #3c763d;
    }

    .whitelist-status.inactive {
      background-color: #f2dede;
      color: #a94442;
    }

    .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 0.9rem;
      border-radius: 3px;
    }

    .btn-danger {
      background-color: #d9534f;
      color: white;
      border: none;
    }

    .btn-warning {
      background-color: #f0ad4e;
      color: white;
      border: none;
    }

    /* Whitelist Styles */
    .whitelist-section {
      margin-bottom: 2rem;
    }

    .whitelist-form,
    .whitelist-table {
      margin-bottom: 2rem;
    }

    .add-email-form {
      padding: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-color-primary);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
    }

    .form-group textarea {
      height: 100px;
      resize: vertical;
    }

    .btn-primary {
      background-color: var(--accent-blue);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
      background-color: var(--primary-navy);
    }

    /* Tabellen-Styles */
    #whitelistTable {
      width: 100%;
      border-collapse: collapse;
    }

    #whitelistTable th,
    #whitelistTable td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    #whitelistTable th {
      background-color: var(--bg-light);
      font-weight: 600;
      color: var(--text-color-primary);
    }

    #whitelistTable tbody tr:hover {
      background-color: var(--bg-light);
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status-active {
      background-color: #e6f4ea;
      color: #1e7e34;
    }

    .status-inactive {
      background-color: #fbe9e7;
      color: #d32f2f;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-action {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      border: 1px solid;
      background: transparent;
      transition: all 0.3s ease;
    }

    .btn-toggle {
      border-color: var(--accent-blue);
      color: var(--accent-blue);
    }

    .btn-toggle:hover {
      background-color: var(--accent-blue);
      color: white;
    }

    .btn-delete {
      border-color: #dc3545;
      color: #dc3545;
    }

    .btn-delete:hover {
      background-color: #dc3545;
      color: white;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    /* Fahrer-Übersicht Styles */
    .drivers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      padding: 1rem 0;
    }

    .driver-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1.5rem;
    }

    .driver-header {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .driver-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--accent-blue);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 500;
      margin-right: 1rem;
    }

    .driver-info {
      flex: 1;
    }

    .driver-name {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .driver-contact {
      font-size: 0.9rem;
      color: var(--text-color-secondary);
    }

    .driver-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
      margin-top: 0.5rem;
    }

    .status-free {
      background-color: #e6f4ea;
      color: #1e7e34;
    }

    .status-busy {
      background-color: #fef3cd;
      color: #856404;
    }

    .current-order {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .order-title {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .order-details {
      font-size: 0.9rem;
      color: var(--text-color-secondary);
      margin-bottom: 0.75rem;
    }

    .progress-container {
      background-color: #f5f5f5;
      border-radius: 4px;
      height: 8px;
      margin-top: 0.5rem;
    }

    .progress-bar {
      height: 100%;
      border-radius: 4px;
      background-color: var(--accent-blue);
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.85rem;
      color: var(--text-color-secondary);
      margin-top: 0.25rem;
      text-align: right;
    }

    /* Fahrer-Grid Styles */
    .drivers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      padding: 1rem;
    }

    .driver-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1.5rem;
      position: relative;
    }

    .driver-card .driver-header {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .driver-card .driver-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--accent-blue);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      margin-right: 1rem;
    }

    .driver-card .driver-info {
      flex: 1;
    }

    .driver-card .driver-name {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 0.25rem 0;
      color: var(--primary-navy);
    }

    .driver-card .driver-email {
      font-size: 0.9rem;
      color: var(--text-color-secondary);
      margin: 0;
    }

    .driver-card .status-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .driver-card .status-badge.available {
      background-color: rgba(40, 167, 69, 0.2);
      color: #155724;
    }

    .driver-card .status-badge.busy {
      background-color: rgba(0, 123, 255, 0.2);
      color: #004085;
    }

    .driver-card .order-info {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      font-size: 0.9rem;
    }

    .driver-card .order-info p {
      margin: 0.25rem 0;
      color: var(--text-color-secondary);
    }

    .driver-card .order-info strong {
      color: var(--text-color-primary);
    }
  </style>
</head>
<body>
  <div class="main-wrapper">

    <header class="section hero-small">
      <div class="hero-nav-container">
        <a href="index.html"><img src="logo.png" alt="NorthDrive Logo" class="logo"></a>
        <nav class="hero-nav">
          <ul>
            <li><a href="index.html">Startseite</a></li>
            <li><a href="manager-dashboard.html" class="active">Dashboard</a></li>
            <li><a href="impressum.html">Impressum</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <div class="dashboard-container">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><a href="#dashboard" class="active" data-section="dashboard-section">Dashboard</a></li>
          <li><a href="#whitelist" data-section="whitelist-section">Whitelist</a></li>
          <li><a href="#drivers" data-section="drivers-section">Fahrer</a></li>
          <li><a href="#">Aufträge</a></li>
          <li><a href="#">Kunden</a></li>
          <li><a href="#">Fahrzeuge</a></li>
          <li><a href="#">Berichte</a></li>
          <li><a href="#">Finanzen</a></li>
          <li><a href="#">Einstellungen</a></li>
        </ul>
      </div>

      <div class="content-area">
        <div class="dashboard-header">
          <div class="user-welcome">
            Willkommen, <span id="userName" class="loading-name">Manager</span>
          </div>
          <button id="logoutBtn" class="logout-btn">Abmelden</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section active">
          <!-- Bestehender Dashboard-Content -->
          <div class="dashboard-stats">
            <div class="stat-card">
              <h3>Aktive Aufträge</h3>
              <div id="activeOrdersValue" class="stat-value">-</div>
              <div id="activeOrdersChange" class="stat-change">Wird geladen...</div>
            </div>
            
            <div class="stat-card">
              <h3>Verfügbare Fahrer</h3>
              <div id="availableDriversValue" class="stat-value">-</div>
              <div id="availableDriversChange" class="stat-change">Wird geladen...</div>
            </div>
            
            <div class="stat-card">
              <h3>Offene Aufträge</h3>
              <div id="availableOrdersValue" class="stat-value">-</div>
              <div id="availableOrdersChange" class="stat-change">Wird geladen...</div>
            </div>
            
            <div class="stat-card">
              <h3>Abgeschlossene Aufträge</h3>
              <div id="completedOrdersValue" class="stat-value">-</div>
              <div id="completedOrdersChange" class="stat-change">Wird geladen...</div>
            </div>
          </div>
          
          <div class="action-buttons">
            <button id="newOrderBtn" class="action-btn">Neuen Auftrag erstellen</button>
            <button id="addDriverBtn" class="action-btn">Fahrer hinzufügen</button>
            <button id="generateReportBtn" class="action-btn">Bericht erstellen</button>
          </div>
          
          <div class="dashboard-grid">
            <div class="dashboard-card">
              <div class="dashboard-card-header">
                <h3>Aktuelle Aufträge</h3>
                <a href="#" class="view-all">Alle anzeigen</a>
              </div>
              <div class="dashboard-card-body">
                <table class="orders-table">
                  <thead>
                    <tr>
                      <th>Auftrag-Nr.</th>
                      <th>Kunde</th>
                      <th>Route</th>
                      <th>Fahrer</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="ordersTableBody">
                    <!-- Orders will be loaded dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <div class="dashboard-card">
              <div class="dashboard-card-header">
                <h3>Verfügbare Fahrer</h3>
                <a href="#" class="view-all">Alle anzeigen</a>
              </div>
              <div class="dashboard-card-body">
                <ul class="driver-list" id="driverList">
                  <!-- Drivers will be loaded dynamically -->
                </ul>
              </div>
            </div>
          </div>
          
          <div class="dashboard-grid">
            <div class="dashboard-card">
              <div class="dashboard-card-header">
                <h3>Auftragsstatistik</h3>
                <select id="chartPeriod">
                  <option value="week">Diese Woche</option>
                  <option value="month" selected>Dieser Monat</option>
                  <option value="year">Dieses Jahr</option>
                </select>
              </div>
              <div class="dashboard-card-body">
                <div class="chart-container">
                  <!-- Chart will be rendered here -->
                  <p style="text-align: center; padding: 100px 0;">Hier würde ein Chart angezeigt werden.</p>
                </div>
              </div>
            </div>
            
            <div class="dashboard-card">
              <div class="dashboard-card-header">
                <h3>Benachrichtigungen</h3>
                <a href="#" class="view-all">Alle anzeigen</a>
              </div>
              <div class="dashboard-card-body">
                <div class="notification-list" id="notificationList">
                  <!-- Notifications will be loaded dynamically -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Whitelist Section -->
        <div id="whitelist-section" class="content-section">
          <div class="section-title">
            <h2>Whitelist-Verwaltung</h2>
          </div>
          
          <!-- Formular zum Hinzufügen neuer E-Mail-Adressen -->
          <div class="whitelist-form dashboard-card">
            <div class="dashboard-card-header">
              <h3>Neue E-Mail-Adresse hinzufügen</h3>
            </div>
            <div class="dashboard-card-body">
              <form id="whitelistForm" class="add-email-form">
                <div class="form-group">
                  <label for="email">E-Mail-Adresse</label>
                  <input type="email" id="email" required>
                </div>
                <div class="form-group">
                  <label for="role">Rolle</label>
                  <select id="role" required>
                    <option value="driver">Fahrer</option>
                    <option value="client">Auftraggeber</option>
                    <option value="manager">Manager</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="notes">Notizen</label>
                  <textarea id="notes"></textarea>
                </div>
                <button type="submit" class="btn-primary">Hinzufügen</button>
              </form>
            </div>
          </div>

          <!-- Whitelist-Tabelle -->
          <div class="whitelist-table dashboard-card">
            <div class="dashboard-card-header">
              <h3>Freigeschaltete E-Mail-Adressen</h3>
            </div>
            <div class="dashboard-card-body">
              <table id="whitelistTable">
                <thead>
                  <tr>
                    <th>E-Mail</th>
                    <th>Rolle</th>
                    <th>Status</th>
                    <th>Erstellt am</th>
                    <th>Notizen</th>
                    <th>Aktionen</th>
                  </tr>
                </thead>
                <tbody id="whitelistTableBody">
                  <!-- Wird dynamisch befüllt -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Drivers Section -->
        <div id="drivers-section" class="content-section">
          <div class="section-title">
            <h2>Fahrer-Übersicht</h2>
          </div>

          <div class="drivers-grid">
            <!-- Fahrer-Karten werden hier dynamisch eingefügt -->
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Firebase SDK v9+ modular imports
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { 
        getFirestore, 
        collection, 
        query, 
        where, 
        getDocs, 
        doc, 
        getDoc, 
        onSnapshot,
        orderBy,
        limit,
        addDoc, 
        updateDoc,
        deleteDoc,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyC_KAYTuhfjpASvzvI1zgdNam7BzliB3mM",
        authDomain: "appnorthdrive.firebaseapp.com",
        projectId: "appnorthdrive",
        storageBucket: "appnorthdrive.firebasestorage.app",
        messagingSenderId: "559746363897",
        appId: "1:559746363897:web:959bffc6e2f374e5448d28",
        measurementId: "G-ZSJL11E70J"
      };

      // Initialize Firebase
      let app = null;
      let auth = null;
      let db = null;

      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase erfolgreich initialisiert");
      } catch (error) {
        console.error("Fehler bei der Firebase-Initialisierung:", error);
        alert("Fehler bei der Firebase-Initialisierung: " + error.message);
      }

      // DOM Elements
      const userNameElement = document.getElementById('userName');
      const logoutBtn = document.getElementById('logoutBtn');
      const ordersTableBody = document.getElementById('ordersTableBody');
      const driverList = document.getElementById('driverList');
      const notificationList = document.getElementById('notificationList');
      const newOrderBtn = document.getElementById('newOrderBtn');
      const addDriverBtn = document.getElementById('addDriverBtn');
      const generateReportBtn = document.getElementById('generateReportBtn');
      const chartPeriod = document.getElementById('chartPeriod');
      
      // Whitelist-Verwaltung Elemente
      const whitelistForm = document.getElementById('whitelistForm');
      const whitelistTableBody = document.getElementById('whitelistTableBody');
      let unsubscribeWhitelist = null;

      // Check if user is logged in
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // User is signed in
          try {
            // Get user data from Firestore
            const userDoc = await getDoc(doc(db, "users", user.uid));
            
            if (userDoc.exists()) {
              const userData = userDoc.data();
              
              // Check if user is a manager
              if (userData.role !== 'manager') {
                alert("Sie haben keine Berechtigung für den Manager-Bereich.");
                window.location.href = "login.html";
                return;
              }
              
              // Display user name
              userNameElement.textContent = userData.displayName || userData.name || user.email || "Manager";
              userNameElement.classList.remove('loading-name');
              
              // Load dashboard data
              loadDashboardStats();
              loadOrders();
              loadDrivers();
              loadNotifications();
              initializeWhitelistListener(); // Whitelist-Daten laden
            } else {
              console.error("Keine Benutzerdaten gefunden");
              window.location.href = "login.html";
            }
          } catch (error) {
            console.error("Fehler beim Abrufen der Benutzerdaten:", error);
            alert("Fehler beim Abrufen der Benutzerdaten: " + error.message);
          }
        } else {
          // User is signed out, redirect to login page
          window.location.href = "login.html";
        }
      });

      // Whitelist-Formular Handler
      whitelistForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const role = document.getElementById('role').value;
        const notes = document.getElementById('notes').value;

        try {
          await addDoc(collection(db, "whitelist"), {
            email: email.toLowerCase(),
            role: role,
            notes: notes,
            status: 'active',
            createdAt: serverTimestamp()
          });

          // Formular zurücksetzen
          whitelistForm.reset();
          alert('E-Mail-Adresse erfolgreich zur Whitelist hinzugefügt!');
        } catch (error) {
          console.error("Fehler beim Hinzufügen zur Whitelist:", error);
          alert('Fehler beim Hinzufügen zur Whitelist. Bitte versuchen Sie es erneut.');
        }
      });

      // Whitelist-Tabelle Listener
      function initializeWhitelistListener() {
        if (unsubscribeWhitelist) {
          unsubscribeWhitelist();
        }

        const whitelistQuery = query(collection(db, "whitelist"));
        unsubscribeWhitelist = onSnapshot(whitelistQuery, (snapshot) => {
          whitelistTableBody.innerHTML = '';
          
          snapshot.forEach((doc) => {
            const data = doc.data();
            const tr = document.createElement('tr');
            
            const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString('de-DE') : 'Unbekannt';
            
            tr.innerHTML = `
              <td>${data.email}</td>
              <td>${translateRole(data.role)}</td>
              <td>
                <span class="status-badge ${data.status === 'active' ? 'status-active' : 'status-inactive'}">
                  ${data.status === 'active' ? 'Aktiv' : 'Inaktiv'}
                </span>
              </td>
              <td>${createdAt}</td>
              <td>${data.notes || '-'}</td>
              <td class="action-buttons">
                <button class="btn-action btn-toggle" onclick="toggleWhitelistStatus('${doc.id}', '${data.status}')">
                  ${data.status === 'active' ? 'Deaktivieren' : 'Aktivieren'}
                </button>
                <button class="btn-action btn-delete" onclick="deleteWhitelistEntry('${doc.id}')">
                  Löschen
                </button>
              </td>
            `;
            
            whitelistTableBody.appendChild(tr);
          });
        });
      }

      // Hilfsfunktion zum Übersetzen der Rollen
      function translateRole(role) {
        const roles = {
          'driver': 'Fahrer',
          'client': 'Auftraggeber',
          'manager': 'Manager'
        };
        return roles[role] || role;
      }

      // Whitelist-Funktionen global verfügbar machen
      window.toggleWhitelistStatus = async (docId, currentStatus) => {
        try {
          const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
          await updateDoc(doc(db, "whitelist", docId), {
            status: newStatus
          });
        } catch (error) {
          console.error("Fehler beim Ändern des Status:", error);
          alert('Fehler beim Ändern des Status. Bitte versuchen Sie es erneut.');
        }
      };

      window.deleteWhitelistEntry = async (docId) => {
        if (confirm('Möchten Sie diesen Eintrag wirklich löschen?')) {
          try {
            await deleteDoc(doc(db, "whitelist", docId));
          } catch (error) {
            console.error("Fehler beim Löschen des Eintrags:", error);
            alert('Fehler beim Löschen des Eintrags. Bitte versuchen Sie es erneut.');
          }
        }
      };

      // Logout-Funktion
      logoutBtn.addEventListener('click', () => {
        signOut(auth).then(() => {
          window.location.href = 'login.html';
        }).catch((error) => {
          console.error("Fehler beim Abmelden:", error);
        });
      });

      // Load orders
      function loadOrders() {
        try {
          // Aktuelle Aufträge abfragen (die letzten 5)
          const ordersQuery = query(
            collection(db, "orders"),
            orderBy("createdAt", "desc"),
            limit(5)
          );
          
          // Echtzeit-Listener für Aufträge
          onSnapshot(ordersQuery, async (snapshot) => {
            if (snapshot.empty) {
              ordersTableBody.innerHTML = `
                <tr>
                  <td colspan="5" style="text-align: center; padding: 2rem;">
                    Keine Aufträge gefunden.
                  </td>
                </tr>
              `;
              return;
            }
            
            // HTML für jeden Auftrag generieren
            let ordersHTML = '';
            const ordersPromises = snapshot.docs.map(async (doc) => {
              const orderData = doc.data();
              const orderId = doc.id;
              
              // Kundendaten abrufen
              let customerName = "Unbekannter Kunde";
              if (orderData.clientId) {
                try {
                  const clientDoc = await getDoc(doc(db, "users", orderData.clientId));
                  if (clientDoc.exists()) {
                    const clientData = clientDoc.data();
                    customerName = clientData.displayName || clientData.name || clientData.email || "Unbekannter Kunde";
                  }
                } catch (error) {
                  console.error("Fehler beim Abrufen der Kundendaten:", error);
                }
              }
              
              // Fahrerdaten abrufen
              let driverName = "Nicht zugewiesen";
              if (orderData.driverId) {
                try {
                  const driverDoc = await getDoc(doc(db, "users", orderData.driverId));
                  if (driverDoc.exists()) {
                    const driverData = driverDoc.data();
                    driverName = driverData.displayName || driverData.name || driverData.email || "Unbekannter Fahrer";
                  }
                } catch (error) {
                  console.error("Fehler beim Abrufen der Fahrerdaten:", error);
                }
              }
              
              // Route erstellen
              const pickupLocation = orderData.pickupLocation || "Unbekannt";
              const deliveryLocation = orderData.deliveryLocation || "Unbekannt";
              const route = `${pickupLocation} → ${deliveryLocation}`;
              
              // Status-Badge erstellen
              let statusBadge = '';
              let statusText = '';
              switch(orderData.status) {
                case 'available':
                  statusBadge = '<span class="status-badge pending">Ausstehend</span>';
                  statusText = 'Ausstehend';
                  break;
                case 'assigned':
                  statusBadge = '<span class="status-badge in-progress">In Bearbeitung</span>';
                  statusText = 'In Bearbeitung';
                  break;
                case 'completed':
                  statusBadge = '<span class="status-badge completed">Abgeschlossen</span>';
                  statusText = 'Abgeschlossen';
                  break;
                case 'cancelled':
                  statusBadge = '<span class="status-badge cancelled">Storniert</span>';
                  statusText = 'Storniert';
                  break;
                default:
                  statusBadge = '<span class="status-badge pending">Ausstehend</span>';
                  statusText = 'Ausstehend';
              }
              
              return `
                <tr>
                  <td>ORD-${orderId.substring(0, 6)}</td>
                  <td>${customerName}</td>
                  <td>${route}</td>
                  <td>${driverName}</td>
                  <td>${statusBadge}</td>
                </tr>
              `;
            });
            
            // Alle Aufträge laden und HTML aktualisieren
            const ordersHTMLArray = await Promise.all(ordersPromises);
            ordersTableBody.innerHTML = ordersHTMLArray.join('');
            
          }, (error) => {
            console.error("Fehler beim Laden der Aufträge:", error);
            ordersTableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 2rem;">
                  Fehler beim Laden der Aufträge. Bitte versuchen Sie es später erneut.
                </td>
              </tr>
            `;
          });
          
        } catch (error) {
          console.error("Fehler beim Laden der Aufträge:", error);
          ordersTableBody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 2rem;">
                Fehler beim Laden der Aufträge. Bitte versuchen Sie es später erneut.
              </td>
            </tr>
          `;
        }
      }

      // Load drivers
      function loadDrivers() {
        try {
          // Fahrer abfragen (die letzten 5)
          const driversQuery = query(
            collection(db, "users"),
            where("role", "==", "driver"),
            limit(5)
          );
          
          // Echtzeit-Listener für Fahrer
          onSnapshot(driversQuery, (snapshot) => {
            if (snapshot.empty) {
              driverList.innerHTML = `
                <li style="text-align: center; padding: 2rem;">
                  Keine Fahrer gefunden.
                </li>
              `;
              return;
            }
            
            // HTML für jeden Fahrer generieren
            let driversHTML = '';
            snapshot.forEach(doc => {
              const driverData = doc.data();
              const driverId = doc.id;
              
              // Name und Initialen erstellen
              const driverName = driverData.displayName || driverData.name || driverData.email || "Unbekannter Fahrer";
              const initials = driverName.split(' ').map(n => n[0]).join('');
              
              // Status und Standort
              const driverStatus = driverData.status || "unknown";
              const statusClass = driverStatus === 'available' ? 'available' : 'busy';
              const statusText = driverStatus === 'available' ? 'Verfügbar' : 'Beschäftigt';
              
              // Standort (falls vorhanden)
              let locationText = driverData.currentLocation || "Standort unbekannt";
              
              driversHTML += `
                <li class="driver-item">
                  <div class="driver-avatar">${initials}</div>
                  <div class="driver-info">
                    <div class="driver-name">${driverName}</div>
                    <div class="driver-status ${statusClass}">${statusText} - ${locationText}</div>
                  </div>
                </li>
              `;
            });
            
            driverList.innerHTML = driversHTML;
            
          }, (error) => {
            console.error("Fehler beim Laden der Fahrer:", error);
            driverList.innerHTML = `
              <li style="text-align: center; padding: 2rem;">
                Fehler beim Laden der Fahrer. Bitte versuchen Sie es später erneut.
              </li>
            `;
          });
          
        } catch (error) {
          console.error("Fehler beim Laden der Fahrer:", error);
          driverList.innerHTML = `
            <li style="text-align: center; padding: 2rem;">
              Fehler beim Laden der Fahrer. Bitte versuchen Sie es später erneut.
            </li>
          `;
        }
      }

      // Load notifications
      function loadNotifications() {
        try {
          // Benachrichtigungen abfragen (die letzten 5)
          const notificationsQuery = query(
            collection(db, "notifications"),
            orderBy("timestamp", "desc"),
            limit(5)
          );
          
          // Echtzeit-Listener für Benachrichtigungen
          onSnapshot(notificationsQuery, (snapshot) => {
            if (snapshot.empty) {
              notificationList.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                  Keine Benachrichtigungen vorhanden.
                </div>
              `;
              return;
            }
            
            // HTML für jede Benachrichtigung generieren
            let notificationsHTML = '';
            snapshot.forEach(doc => {
              const notificationData = doc.data();
              
              // Zeitstempel formatieren
              let timeText = "Gerade eben";
              if (notificationData.timestamp) {
                const timestamp = notificationData.timestamp.toDate();
                const now = new Date();
                const diffMs = now - timestamp;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                  timeText = `Vor ${diffDays} ${diffDays === 1 ? 'Tag' : 'Tagen'}`;
                } else if (diffHours > 0) {
                  timeText = `Vor ${diffHours} ${diffHours === 1 ? 'Stunde' : 'Stunden'}`;
                } else if (diffMins > 0) {
                  timeText = `Vor ${diffMins} ${diffMins === 1 ? 'Minute' : 'Minuten'}`;
                }
              }
              
              notificationsHTML += `
                <div class="notification-item">
                  <div class="notification-title">${notificationData.title || 'Benachrichtigung'}</div>
                  <div class="notification-message">${notificationData.message || 'Keine Nachricht'}</div>
                  <div class="notification-time">${timeText}</div>
                </div>
              `;
            });
            
            notificationList.innerHTML = notificationsHTML;
            
          }, (error) => {
            console.error("Fehler beim Laden der Benachrichtigungen:", error);
            notificationList.innerHTML = `
              <div style="text-align: center; padding: 2rem;">
                Fehler beim Laden der Benachrichtigungen. Bitte versuchen Sie es später erneut.
              </div>
            `;
          });
          
        } catch (error) {
          console.error("Fehler beim Laden der Benachrichtigungen:", error);
          notificationList.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              Fehler beim Laden der Benachrichtigungen. Bitte versuchen Sie es später erneut.
            </div>
          `;
        }
      }

      // Dashboard-Statistiken laden
      function loadDashboardStats() {
        // Aktive Aufträge (assigned)
        const activeOrdersQuery = query(
          collection(db, "orders"),
          where("status", "==", "assigned")
        );
        
        // Verfügbare Fahrer (ohne aktiven Auftrag)
        const availableDriversQuery = query(
          collection(db, "users"),
          where("role", "==", "driver"),
          where("status", "==", "available")
        );
        
        // Offene Aufträge (available)
        const availableOrdersQuery = query(
          collection(db, "orders"),
          where("status", "==", "available")
        );
        
        // Abgeschlossene Aufträge
        const completedOrdersQuery = query(
          collection(db, "orders"),
          where("status", "==", "completed")
        );
        
        // Echtzeit-Listener für aktive Aufträge
        onSnapshot(activeOrdersQuery, (snapshot) => {
          const count = snapshot.size;
          activeOrdersValue.textContent = count;
          activeOrdersChange.textContent = count === 1 ? "Aktiver Auftrag" : "Aktive Aufträge";
        }, (error) => {
          console.error("Fehler beim Laden der aktiven Aufträge:", error);
          activeOrdersValue.textContent = "-";
          activeOrdersChange.textContent = "Fehler beim Laden";
        });
        
        // Echtzeit-Listener für verfügbare Fahrer
        onSnapshot(availableDriversQuery, (snapshot) => {
          const count = snapshot.size;
          availableDriversValue.textContent = count;
          availableDriversChange.textContent = count === 1 ? "Verfügbarer Fahrer" : "Verfügbare Fahrer";
        }, (error) => {
          console.error("Fehler beim Laden der verfügbaren Fahrer:", error);
          availableDriversValue.textContent = "-";
          availableDriversChange.textContent = "Fehler beim Laden";
        });
        
        // Echtzeit-Listener für offene Aufträge
        onSnapshot(availableOrdersQuery, (snapshot) => {
          const count = snapshot.size;
          availableOrdersValue.textContent = count;
          availableOrdersChange.textContent = count === 1 ? "Offener Auftrag" : "Offene Aufträge";
        }, (error) => {
          console.error("Fehler beim Laden der offenen Aufträge:", error);
          availableOrdersValue.textContent = "-";
          availableOrdersChange.textContent = "Fehler beim Laden";
        });
        
        // Echtzeit-Listener für abgeschlossene Aufträge
        onSnapshot(completedOrdersQuery, (snapshot) => {
          const count = snapshot.size;
          completedOrdersValue.textContent = count;
          
          // Letzten Monat berechnen (für die Änderungsanzeige)
          const oneMonthAgo = new Date();
          oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
          
          // Zählen, wie viele Aufträge im letzten Monat abgeschlossen wurden
          let lastMonthCount = 0;
          snapshot.forEach(doc => {
            const completedAt = doc.data().completedAt?.toDate();
            if (completedAt && completedAt > oneMonthAgo) {
              lastMonthCount++;
            }
          });
          
          completedOrdersChange.textContent = `+${lastMonthCount} im letzten Monat`;
        }, (error) => {
          console.error("Fehler beim Laden der abgeschlossenen Aufträge:", error);
          completedOrdersValue.textContent = "-";
          completedOrdersChange.textContent = "Fehler beim Laden";
        });
      }

      // Button event listeners
      newOrderBtn.addEventListener('click', () => {
        alert('Funktion zum Erstellen eines neuen Auftrags wird geöffnet.');
      });

      addDriverBtn.addEventListener('click', () => {
        alert('Funktion zum Hinzufügen eines neuen Fahrers wird geöffnet.');
      });

      generateReportBtn.addEventListener('click', () => {
        alert('Funktion zum Erstellen eines Berichts wird geöffnet.');
      });

      // Chart period change
      chartPeriod.addEventListener('change', () => {
        alert(`Diagramm wird für Zeitraum "${chartPeriod.options[chartPeriod.selectedIndex].text}" aktualisiert.`);
        // In a real application, you would update the chart here
      });

      // Navigation zwischen Sektionen
      document.querySelectorAll('.sidebar-menu a[data-section]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Aktive Klasse von allen Links entfernen
          document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
          
          // Aktive Klasse zum geklickten Link hinzufügen
          e.target.classList.add('active');
          
          // Alle Sektionen ausblenden
          document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
          });
          
          // Gewählte Sektion einblenden
          const sectionId = e.target.getAttribute('data-section');
          document.getElementById(sectionId).classList.add('active');
          
          // Whitelist-Daten laden, wenn Whitelist-Sektion aktiviert wird
          if (sectionId === 'whitelist-section') {
            initializeWhitelistListener();
          }

          // Fahrer-Daten laden, wenn Fahrer-Sektion aktiviert wird
          if (sectionId === 'drivers-section') {
            initializeDriversView();
          }
        });
      });

      // Fahrer-Übersicht initialisieren
      async function initializeDriversView() {
        const driversGrid = document.querySelector('.drivers-grid');
        
        // Query für alle Fahrer
        const driversQuery = query(
          collection(db, "users"),
          where("role", "==", "driver")
        );

        // Echtzeit-Updates für Fahrer
        onSnapshot(driversQuery, async (snapshot) => {
          driversGrid.innerHTML = ''; // Grid leeren
          
          for (const doc of snapshot.docs) {
            const driverData = doc.data();
            
            // Aktiven Auftrag des Fahrers abrufen
            const activeOrderQuery = query(
              collection(db, "orders"),
              where("driverId", "==", doc.id),
              where("status", "==", "assigned"),
              limit(1)
            );
            
            const activeOrderSnapshot = await getDocs(activeOrderQuery);
            const activeOrder = activeOrderSnapshot.docs[0]?.data();
            const isBusy = !!activeOrder;
            
            // Fahrer-Karte erstellen
            const driverCard = document.createElement('div');
            driverCard.className = 'driver-card';
            
            const initials = (driverData.firstName?.[0] || '') + (driverData.lastName?.[0] || '');
            
            driverCard.innerHTML = `
              <div class="driver-header">
                <div class="driver-avatar">${initials || '?'}</div>
                <div class="driver-info">
                  <h3 class="driver-name">${driverData.firstName} ${driverData.lastName}</h3>
                  <p class="driver-email">${driverData.email}</p>
                </div>
              </div>
              <div class="status-badge ${isBusy ? 'busy' : 'available'}">
                ${isBusy ? 'Im Auftrag' : 'Verfügbar'}
              </div>
              ${isBusy && activeOrder ? `
                <div class="order-info">
                  <p><strong>Aktueller Auftrag:</strong></p>
                  <p><strong>Start:</strong> ${activeOrder.pickupLocation}</p>
                  <p><strong>Ziel:</strong> ${activeOrder.deliveryLocation}</p>
                </div>
              ` : ''}
            `;
            
            driversGrid.appendChild(driverCard);
          }
        });
      }
    </script>
  </div>
</body>
</html> 